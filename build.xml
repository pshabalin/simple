<project xmlns:ivy="antlib:org.apache.ivy.ant" name="simple" default="configure" xmlns:if="ant:if" xmlns:unless="ant:unless">

    <loadproperties srcFile="build.properties"/>
    <property name="buildDir" value="build"/>
    <property name="classesDir" value="classes"/>
    <property name="libDir" value="ivy/lib/main"/>
    <property name="buildInfoFile" value="${buildDir}/build.txt"/>

    <path id="main.classpath">
        <fileset dir="${libDir}">
            <include name="**/*.jar"/>
        </fileset>
    </path>

    <target name="clean">
        <delete dir="ivy"/>
        <delete dir="${buildDir}"/>
        <delete dir="data"/>
    </target>

    <!-- Dependency Management -->

    <target name="install-ivy">
        <mkdir dir="ivy"/>
        <get src="http://repo1.maven.org/maven2/org/apache/ivy/ivy/${ivy.version}/ivy-${ivy.version}.jar" dest="ivy/ivy.jar" usetimestamp="true"/>
        <path id="ivy.lib.path">
            <fileset dir="ivy" includes="*.jar"/>
        </path>
        <taskdef resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant" classpathref="ivy.lib.path"/>
    </target>

    <target name="resolve-dependencies" depends="install-ivy">
        <mkdir dir="ivy/lib"/>
        <ivy:retrieve pattern="ivy/lib/[conf]/[artifact]-[type]-[revision].[ext]" symlink="true"/>
    </target>

    <!-- Build  -->

    <target name="prepare">
        <mkdir dir="${buildDir}"/>
        <mkdir dir="${buildDir}/${classesDir}"/>
    </target>

    <target name="compile" depends="prepare, resolve-dependencies">
        <javac srcdir="src" destdir="${buildDir}/${classesDir}" target="${target.version}" includeAntRuntime="false">
            <classpath refid="main.classpath"/>
        </javac>
    </target>

    <target name="test" depends="compile">
        <path id="test.compile">
            <path refid="main.classpath"/>
            <fileset dir="ivy/lib/test">
                <include name="**/*.jar"/>
            </fileset>
            <pathelement location="${buildDir}/${classesDir}"/>
        </path>

        <mkdir dir="${buildDir}/test-classes"/>

        <javac srcdir="test" destdir="${buildDir}/test-classes" target="${target.version}" includeAntRuntime="false">
            <classpath refid="test.compile"/>
        </javac>

        <taskdef resource="testngtasks" classpath="ivy/lib/test/testng-jar-${testng.version}.jar"/>

        <path id="test">
            <path refid="test.compile"/>
            <pathelement location="${buildDir}/test-classes"/>
        </path>

         <testng classpathref="test" outputDir="${buildDir}/test" haltOnfailure="true">
             <classfileset dir="${buildDir}/test-classes" includes="**/*.class" />
         </testng>
    </target>

    <target name="jar" depends="compile">
        <jar destfile="${buildDir}/${ant.project.name}-${project.version}.jar" basedir="${buildDir}/${classesDir}"/>
    </target>

    <target name="zip" depends="jar">
        <mkdir dir="${buildDir}/logs"/>
        <mkdir dir="${buildDir}/data"/>
        <zip destfile="${buildDir}/${ant.project.name}-${project.version}.zip" >
            <zipfileset dir="${libDir}" prefix="lib" includes="*.jar" excludes="*-javadoc-*.jar,*-source-*.jar"/>
            <zipfileset dir="${buildDir}" prefix="lib" includes="*.jar"/>
            <zipfileset dir="sql" prefix="sql"/>
            <zipfileset dir="webapp" prefix="webapp"/>
            <zipfileset dir="runtime" includes="application.properties,logback.xml" prefix="config"/>
            <zipfileset dir="${buildDir}/logs" prefix="logs"/>
            <zipfileset dir="${buildDir}/data" prefix="data"/>
            <zipfileset dir="runtime" includes="run.sh" filemode="754"/>
        </zip>
    </target>

    <target name="build"  depends="clean, resolve-dependencies, zip"/>

    <!-- Prepare Project for IDE -->

    <target name="create-runtime">
        <mkdir dir="config"/>
        <mkdir dir="data"/>
        <available file="config/application.properties" property="skipProp"/>
        <copy file="runtime/application.properties" todir="config" unless:true="${skipProp}"/>
        <available file="config/logback.xml" property="skipLogback"/>
        <copy file="runtime/logback.xml" todir="config" unless:true="${skipLogback}"/>
    </target>

    <target name="configure" depends="clean, resolve-dependencies, create-runtime"/>
</project>